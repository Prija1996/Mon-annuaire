<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentification - Mon Annuaire</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        .loading {
            display: none;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Traitement de l'authentification...</h1>
    <div id="loading" class="loading">Veuillez patienter pendant que nous finalisons votre connexion.</div>
    <div id="success" class="success" style="display: none;">Authentification réussie ! Redirection en cours...</div>
    <div id="error" class="error" style="display: none;">Erreur lors de l'authentification. Veuillez réessayer.</div>

    <script>
        // Configuration OAuth 2.0 - À remplacer par vos vraies valeurs
        const CLIENT_ID = '97b8fdcd-2b97-4554-9dc4-80f739432375'; // Remplacez par votre Client ID Airtable
        const CLIENT_SECRET = '662a79e7e7b518be5773d044199e07c306dfe8eb4e92e34ebc58fdc8eb4bdf10'; // Attention : dans un vrai projet, ne pas exposer le secret côté client
        const REDIRECT_URI = 'https://mon-annuaire.vercel.app/callback.html';

        // Fonction pour obtenir les paramètres de l'URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Fonction pour échanger le code contre un token
        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('oauth_code_verifier');

            console.log('Échange du code:', code);
            console.log('Code verifier:', codeVerifier);
            console.log('Client ID:', CLIENT_ID);
            console.log('Redirect URI:', REDIRECT_URI);

            const response = await fetch('https://airtable.com/oauth2/v1/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    client_id: CLIENT_ID,
                    client_secret: CLIENT_SECRET,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier
                })
            });

            console.log('Réponse du serveur:', response.status, response.statusText);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erreur détaillée:', errorText);
                throw new Error(`Erreur ${response.status}: ${errorText}`);
            }

            return await response.json();
        }

        // Fonction principale
        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const state = urlParams.get('state');
            const storedState = localStorage.getItem('oauth_state');

            console.log('Paramètres URL:', window.location.search);
            console.log('Code:', code);
            console.log('State reçu:', state);
            console.log('State stocké:', storedState);

            // Vérifier le state pour la sécurité
            if (state !== storedState) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Erreur de sécurité : State invalide';
                return;
            }

            if (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Erreur : ${error}`;
                return;
            }

            if (!code) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Code d\'autorisation manquant dans l\'URL';
                return;
            }

            try {
                const tokenData = await exchangeCodeForToken(code);
                console.log('Token reçu:', tokenData);

                // Nettoyer les données OAuth
                localStorage.removeItem('oauth_state');
                localStorage.removeItem('oauth_code_verifier');

                // Stocker le token dans localStorage
                localStorage.setItem('airtable_access_token', tokenData.access_token);
                if (tokenData.refresh_token) {
                    localStorage.setItem('airtable_refresh_token', tokenData.refresh_token);
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('success').style.display = 'block';

                // Rediriger vers la page principale après 2 secondes
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (err) {
                console.error('Erreur lors de l\'authentification:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Erreur lors de l'échange du token: ${err.message}`;
            }
        }

        // Démarrer le traitement au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading').style.display = 'block';
            handleCallback();
        });
    </script>
</body>
</html>
