<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentification - Mon Annuaire</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }
        .loading {
            display: none;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Traitement de l'authentification...</h1>
    <div id="loading" class="loading">Veuillez patienter pendant que nous finalisons votre connexion.</div>
    <div id="success" class="success" style="display: none;">Authentification réussie ! Redirection en cours...</div>
    <div id="error" class="error" style="display: none;">Erreur lors de l'authentification. Veuillez réessayer.</div>

    <script>
        // Configuration OAuth 2.0
        const CLIENT_ID = '97b8fdcd-2b97-4554-9dc4-80f739432375'; // À remplacer par votre vrai Client ID
        const REDIRECT_URI = window.location.origin + '/callback.html';

        // Fonction pour obtenir les paramètres de l'URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Fonction pour échanger le code contre un token
        async function exchangeCodeForToken(code) {
            const codeVerifier = localStorage.getItem('oauth_code_verifier');

            console.log('Échange du code:', code);
            console.log('Code verifier:', codeVerifier);
            console.log('Client ID:', CLIENT_ID);
            console.log('Redirect URI:', REDIRECT_URI);

            const response = await fetch('/api/oauth-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: code,
                    codeVerifier: codeVerifier,
                    clientId: CLIENT_ID,
                    redirectUri: REDIRECT_URI
                })
            });

            console.log('Réponse du serveur:', response.status, response.statusText);

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Erreur détaillée:', errorData);
                throw new Error(`Erreur ${response.status}: ${errorData.error || 'Unknown error'}`);
            }

            return await response.json();
        }

        // Fonction principale
        async function handleCallback() {
            console.log('Callback OAuth - Analyse des paramètres');
            console.log('URL complète:', window.location.href);
            console.log('Search params:', window.location.search);

            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            const state = urlParams.get('state');
            const storedState = localStorage.getItem('oauth_state');

            console.log('Analyse détaillée:');
            console.log('  Code:', code);
            console.log('  Error:', error);
            console.log('  Error Description:', errorDescription);
            console.log('  State reçu:', `"${state}"`);
            console.log('  State stocké:', `"${storedState}"`);

            // Lister tous les paramètres
            console.log('Tous les paramètres reçus:');
            for (let [key, value] of urlParams) {
                console.log(`  ${key}: "${value}"`);
            }

            // Vérifier le state pour la sécurité
            if (state !== storedState) {
                console.log('Échec de vérification state:', { received: state, stored: storedState });
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Erreur de sécurité : State invalide';
                return;
            }

            if (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Erreur : ${error}`;
                return;
            }

            if (!code) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Code d\'autorisation manquant dans l\'URL';
                return;
            }

            try {
                const tokenData = await exchangeCodeForToken(code);
                console.log('Token reçu:', tokenData);

                // Nettoyer les données OAuth
                localStorage.removeItem('oauth_state');
                localStorage.removeItem('oauth_code_verifier');

                // Stocker le token dans localStorage
                localStorage.setItem('airtable_access_token', tokenData.access_token);
                if (tokenData.refresh_token) {
                    localStorage.setItem('airtable_refresh_token', tokenData.refresh_token);
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('success').style.display = 'block';

                // Rediriger vers la page principale après 2 secondes
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (err) {
                console.error('Erreur lors de l\'authentification:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Erreur lors de l'échange du token: ${err.message}`;
            }
        }

        // Démarrer le traitement au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading').style.display = 'block';
            handleCallback();
        });
    </script>
</body>
</html>
